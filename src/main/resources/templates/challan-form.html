<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>NiiRAN Challans</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .logo { max-width: 100px; }
        .header { text-align: center; margin-bottom: 40px; }
        .form-section { background-color: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .form-label { font-weight: 600; }
        .item-section { background-color: #f1f3f5; border-left: 4px solid #0d6efd; padding: 15px; border-radius: 8px; }
        .btn-add, .btn-generate { width: 100%; }
        .col-divider { border-left: 1px solid #dee2e6; }
        .section-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 1rem; }
    </style>
</head>
<body>
<div class="container mt-5">
    <!-- Logo & Header -->
    <div class="header">
        <img src="/images/logo.png" alt="Company Logo" class="logo mb-2">
        <h2 class="fw-bold">NiiRAN ENGINEERING & MANUFACTURING</h2>
    </div>

    <div class="form-section">
        <form id="challanForm">
            <!-- Hidden challanId for edit mode -->
            <input type="hidden" name="challanId" th:value="${challan?.id}">
            <input type="hidden" name="date" id="date">

            <div class="row">
                <!-- Challan Details -->
                <div class="col-md-6 pe-md-4">
                    <div class="section-title">Challan Details</div>
                    <div class="mb-3">
                        <label class="form-label">Challan No</label>
                        <input type="text" name="challanNo" class="form-control" th:value="${challan?.challanNo}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">OEM Supplier (Vendor Partner’s)</label>
                        <input type="text" name="customerName" class="form-control" th:value="${challan?.customerName}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Challan Ref No/PO</label>
                        <input type="text" name="refChNo" class="form-control" th:value="${challan?.refChNo}" disabled>
                    </div>
                </div>

                <!-- Items Section -->
                <div class="col-md-6 ps-md-4 col-divider">
                    <div class="section-title">Items</div>
                    <div id="items">
                        <!-- Existing items loop -->
                        <div th:each="item : ${challan?.items}" class="item-section mb-3" th:attr="data-item-id=${item.id}">
                            <div class="mb-2"><input type="text" name="description" class="form-control" th:value="${item.description}" placeholder="Components" required></div>
                            <div class="mb-2"><input type="text" name="process" class="form-control" th:value="${item.process}" placeholder="Process (Job Work)" required></div>
                            <div class="mb-2"><input type="text" name="hsnCode" class="form-control" th:value="${item.hsnCode}" placeholder="HSN Code" required></div>
                            <div class="mb-2"><input type="text" name="unit" class="form-control" th:value="${item.unit}" placeholder="Unit" required></div>
                            <div class="mb-2"><input type="number" step="0.01" name="weight" class="form-control weight" th:value="${item.weight}" placeholder="Weight (Kg)" required></div>
                            <div class="mb-2"><input type="number" step="0.01" name="piecesPerKg" class="form-control pieces-per-kg" th:value="${item.piecesPerKg}" placeholder="Pieces Per (/Kg)" required></div>
                            <div class="mb-2"><input type="number" step="0.01" name="ratePerPiece" class="form-control rate-per-piece" th:value="${item.ratePerPiece}" placeholder="Rate Per Piece (₹)" required></div>
                            <div class="mb-2"><input type="number" name="totalPieces" class="form-control total-pieces" th:value="${item.totalPieces}" placeholder="Total Pieces" readonly></div>
                            <div class="mb-2"><input type="number" step="0.01" name="totalAmount" class="form-control total-amount" th:value="${item.totalAmount}" placeholder="Total Amount (₹)" readonly></div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-add mb-3" onclick="addItem()">+ Add Item</button>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-generate">Save Challan</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function addItem() {
        const container = document.getElementById("items");
        const div = document.createElement("div");
        div.classList.add("item-section", "mb-3");
        div.innerHTML = `
            <div class="mb-2"><input type="text" name="description" class="form-control" placeholder="Components" required></div>
            <div class="mb-2"><input type="text" name="process" class="form-control" placeholder="Process (Job Work)" required></div>
            <div class="mb-2"><input type="text" name="hsnCode" class="form-control" placeholder="HSN Code" required></div>
            <div class="mb-2"><input type="text" name="unit" class="form-control" placeholder="Unit" required></div>
            <div class="mb-2"><input type="number" step="0.01" name="weight" class="form-control weight" placeholder="Weight (Kg)" required></div>
            <div class="mb-2"><input type="number" step="0.01" name="piecesPerKg" class="form-control pieces-per-kg" placeholder="Pieces Per (/Kg)" required></div>
            <div class="mb-2"><input type="number" step="0.01" name="ratePerPiece" class="form-control rate-per-piece" placeholder="Rate Per Piece (₹)" required></div>
            <div class="mb-2"><input type="number" name="totalPieces" class="form-control total-pieces" placeholder="Total Pieces" readonly></div>
            <div class="mb-2"><input type="number" step="0.01" name="totalAmount" class="form-control total-amount" placeholder="Total Amount (₹)" readonly></div>
        `;
        container.appendChild(div);
    }

    function recalculate(itemSection) {
        const weight = parseFloat(itemSection.querySelector(".weight").value) || 0;
        const piecesPerKg = parseFloat(itemSection.querySelector(".pieces-per-kg").value) || 0;
        const ratePerPiece = parseFloat(itemSection.querySelector(".rate-per-piece").value) || 0;
        const totalPieces = weight * piecesPerKg;
        const totalAmount = totalPieces * ratePerPiece;
        itemSection.querySelector(".total-pieces").value = totalPieces.toFixed(0);
        itemSection.querySelector(".total-amount").value = totalAmount.toFixed(2);
    }

    document.addEventListener("input", function (e) {
        if (e.target.closest(".item-section")) {
            recalculate(e.target.closest(".item-section"));
        }
    });

    document.getElementById("challanForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const challanId = document.querySelector("[name='challanId']").value;
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("date").value = today;

        if (challanId) {
            // EDIT MODE → update items
            const items = [];
            document.querySelectorAll("#items .item-section").forEach(section => {
                items.push({
                    id: section.getAttribute("data-item-id") || null,
                    description: section.querySelector("[name='description']").value,
                    process: section.querySelector("[name='process']").value,
                    hsnCode: section.querySelector("[name='hsnCode']").value,
                    unit: section.querySelector("[name='unit']").value,
                    weight: parseFloat(section.querySelector("[name='weight']").value) || 0,
                    piecesPerKg: parseFloat(section.querySelector("[name='piecesPerKg']").value) || 0,
                    ratePerPiece: parseFloat(section.querySelector("[name='ratePerPiece']").value) || 0,
                    totalPieces: parseInt(section.querySelector("[name='totalPieces']").value) || 0,
                    totalAmount: parseFloat(section.querySelector("[name='totalAmount']").value) || 0
            });
        });

        try {
            // Call upsert endpoint for each item
            for (const item of items) {
                await fetch(`/api/challans/upsert/items/${challanId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(item)
                });
            }
            alert("Challan updated successfully!");
            window.location.href = "/challans";
        } catch (err) {
            console.error("Error updating challan:", err);
            alert("Something went wrong while updating.");
        }

    } else {
        // CREATE MODE → new challan
        const form = e.target;
        const challan = {
            challanNo: form.challanNo.value,
            customerName: form.customerName.value,
            refChNo: form.refChNo.value,
            date: today,
            items: []
        };

        document.querySelectorAll("#items .item-section").forEach(item => {
            challan.items.push({
                description: item.querySelector("[name='description']").value,
                process: item.querySelector("[name='process']").value,
                hsnCode: item.querySelector("[name='hsnCode']").value,
                unit: item.querySelector("[name='unit']").value,
                weight: item.querySelector("[name='weight']").value,
                piecesPerKg: parseFloat(item.querySelector("[name='piecesPerKg']").value) || 0,
                ratePerPiece: parseFloat(item.querySelector("[name='ratePerPiece']").value) || 0,
                totalPieces: parseInt(item.querySelector("[name='totalPieces']").value) || 0,
                totalAmount: parseFloat(item.querySelector("[name='totalAmount']").value) || 0
            });
        });

        try {
            const response = await fetch("/api/challan/generate", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(challan)
            });

            if (!response.ok) {
                alert("Error generating Challan PDF.");
                return;
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "challan.pdf";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            window.location.href = "/challans";
        } catch (error) {
            console.error("Error generating challan:", error);
            alert("Something went wrong.");
        }
    }
});
</script>
</body>
</html>
