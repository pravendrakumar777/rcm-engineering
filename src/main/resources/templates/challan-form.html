<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="">
<head>
    <meta charset="UTF-8">
    <title>RCM Challans</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .logo {
            max-width: 100px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .form-section {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .form-label {
            font-weight: 600;
        }

        .item-section {
            background-color: #f1f3f5;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            border-radius: 8px;
        }

        .btn-add, .btn-generate {
            width: 100%;
        }

        .col-divider {
            border-left: 1px solid #dee2e6;
        }

        .section-title {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <!-- Logo & Header -->
    <div class="header">
        <img src="/images/logo.png" alt="Company Logo" class="logo mb-2">
        <h2 class="fw-bold">RCM ENGINEERING & MANUFACTURING</h2>
    </div>

    <div class="form-section">
        <form id="challanForm">
            <div class="row">
                <div class="col-md-6 pe-md-4">
                    <div class="section-title">Challan Details</div>
                    <div class="mb-3">
                        <label class="form-label">Challan No</label>
                        <input type="text" name="challanNo" class="form-control" disabled>
                    </div>
                    <input type="hidden" name="date" id="date">
                    <div class="mb-3">
                        <label class="form-label">OEM Supplier (Vendor Partner’s)</label>
                        <input type="text" name="customerName" class="form-control" required>
                    </div>
                </div>

                <div class="col-md-6 ps-md-4 col-divider">
                    <div class="section-title">Items</div>
                    <div id="items">
                        <div class="item-section mb-3">
                            <div class="mb-2">
                                <input type="text" placeholder="Components" name="description" class="form-control"
                                       required>
                            </div>
                            <div class="mb-2">
                                <input type="text" placeholder="Process (Job Work)" name="process" class="form-control"
                                       required>
                            </div>
                            <div class="mb-2">
                                <input type="text" placeholder="HSN Code" name="hsnCode" class="form-control"
                                       required>
                            </div>
                            <div class="mb-2">
                                <input type="text" placeholder="Unit" name="unit" class="form-control"
                                       required>
                            </div>
                            <div class="mb-2">
                                <input type="text" placeholder="Ref.Challan/PO" name="refChNo" class="form-control">
                            </div>
                            <div class="mb-2">
                                <input type="number" step="0.01" placeholder="Weight (Kg)" name="weight"
                                       class="form-control weight" required>
                            </div>
                            <div class="mb-2">
                                <input type="number" step="0.01" placeholder="Pieces Per (/Kg)" name="piecesPerKg"
                                       class="form-control pieces-per-kg" required>
                            </div>
                            <div class="mb-2">
                                <input type="number" step="0.01" placeholder="Rate Per Piece (₹)" name="ratePerPiece"
                                       class="form-control rate-per-piece" required>
                            </div>
                            <div class="mb-2">
                                <input type="number" placeholder="Total Pieces" name="totalPieces"
                                       class="form-control total-pieces" readonly>
                            </div>
                            <div class="mb-2">
                                <input type="number" step="0.01" placeholder="Total Amount (₹)" name="totalAmount"
                                       class="form-control total-amount" readonly>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-add mb-3" onclick="addItem()">+ Add
                        Item
                    </button>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-generate">Generate Challan</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function addItem() {
        const container = document.getElementById("items");
        const div = document.createElement("div");
        div.classList.add("item-section", "mb-3");
        div.innerHTML = `
            <div class="mb-2">
                <input type="text" placeholder="Components" name="description" class="form-control" required>
            </div>
            <div class="mb-2">
                <input type="text" placeholder="Process (Job Work)" name="process" class="form-control" required>
            </div>
            <div class="mb-2">
                <input type="text" placeholder="HSN Code" name="hsnCode" class="form-control" required>
            </div>
            <div class="mb-2">
                <input type="text" placeholder="Unit" name="unit" class="form-control" required>
            </div>
            <div class="mb-2">
                <input type="text" placeholder="Ref. Ch. No." name="refChNo" class="form-control">
            </div>
            <div class="mb-2">
                <input type="number" step="0.01" placeholder="Weight (Kg)" name="weight" class="form-control weight" required>
            </div>
            <div class="mb-2">
                <input type="number" step="0.01" placeholder="Pieces Per (/Kg)" name="piecesPerKg" class="form-control pieces-per-kg" required>
            </div>
            <div class="mb-2">
                <input type="number" step="0.01" placeholder="Rate Per Piece (₹)" name="ratePerPiece" class="form-control rate-per-piece" required>
            </div>
            <div class="mb-2">
                <input type="number" placeholder="Total Pieces" name="totalPieces" class="form-control total-pieces" readonly>
            </div>
            <div class="mb-2">
                <input type="number" step="0.01" placeholder="Total Amount (₹)" name="totalAmount" class="form-control total-amount" readonly>
            </div>
        `;
        container.appendChild(div);
    }

    function recalculate(itemSection) {
        const weight = parseFloat(itemSection.querySelector(".weight").value) || 0;
        const piecesPerKg = parseFloat(itemSection.querySelector(".pieces-per-kg").value) || 0;
        const ratePerPiece = parseFloat(itemSection.querySelector(".rate-per-piece").value) || 0;

        const totalPieces = weight * piecesPerKg;
        const totalAmount = totalPieces * ratePerPiece;

        itemSection.querySelector(".total-pieces").value = totalPieces.toFixed(0);
        itemSection.querySelector(".total-amount").value = totalAmount.toFixed(2);
    }

    document.addEventListener("input", function (e) {
        if (e.target.closest(".item-section")) {
            recalculate(e.target.closest(".item-section"));
        }
    });

    document.getElementById("challanForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const today = new Date().toISOString().split("T")[0];
        document.getElementById("date").value = today;

        const form = e.target;
        const challan = {
            challanNo: form.challanNo.value,
            customerName: form.customerName.value,
            date: today,
            items: []
        };

        document.querySelectorAll("#items .item-section").forEach(item => {
            challan.items.push({
                description: item.querySelector("[name='description']").value,
                process: item.querySelector("[name='process']").value,
                hsnCode: item.querySelector("[name='hsnCode']").value,
                unit: item.querySelector("[name='unit']").value,
                refChNo: item.querySelector("[name='refChNo']").value,
                weight: item.querySelector("[name='weight']").value,
                piecesPerKg: parseFloat(item.querySelector("[name='piecesPerKg']").value) || 0,
                ratePerPiece: parseFloat(item.querySelector("[name='ratePerPiece']").value) || 0,
                totalPieces: parseInt(item.querySelector("[name='totalPieces']").value) || 0,
                totalAmount: parseFloat(item.querySelector("[name='totalAmount']").value) || 0
            });
        });

        try {
            const response = await fetch("/api/challan/generate", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(challan)
            });

            if (!response.ok) {
                alert("Error generating Challan PDF.");
                return;
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "challan.pdf";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            window.location.href = "/challans";
        } catch (error) {
            console.error("Error generating challan:", error);
            alert("Something went wrong.");
        }
    });
</script>
</body>
</html>