<!--=====================================================================================================&ndash;&gt;-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Challan List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            margin-top: 40px;
        }

        .table-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.05);
        }

        .btn-primary, .btn-info, .btn-success {
            border-radius: 4px;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .header-title {
            flex-grow: 1;
            text-align: center;
            margin: 0;
        }

        .btn-new {
            white-space: nowrap;
        }

        table th, table td {
            vertical-align: middle !important;
            padding: 0.6rem 0.75rem;
        }

        /* Prevent wrapping headers */
        table th {
            white-space: nowrap;
            text-align: center;
            background-color: #f8f9fa;
            font-weight: 600;
        }

        table td {
            text-align: center;
        }

        /* Right align numeric columns */
        .text-right {
            text-align: right !important;
        }

        .modal-body table th, .modal-body table td {
            padding: 0.4rem;
        }

        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header-row">
        <div>
            <a href="/challan/form" class="btn btn-success btn-new">+ New Challan</a>
            <a href="/employees" class="btn btn-success btn-new">üë®‚Äçüíº Manage Employees</a>
        </div>
        <h3 class="header-title">Challan List</h3>
        <div style="width: 120px;"></div>
    </div>

    <div class="table-container table-responsive">
        <table class="table table-bordered table-hover" id="challanTable">
            <thead class="table-light">
            <tr>
                <th>Challan No</th>
                <th>OEM Supplier</th>
                <th>Created Date</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="challanModal" tabindex="-1" aria-labelledby="challanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="challanModalLabel">Challan Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="challanDetails">
            </div>
        </div>
    </div>
</div>

<script>
    const escapeHtml = (s) => String(s ?? '')
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;').replace(/'/g, '&#039;');

    const fmtDate = (d) => {
        if (!d) return '';
        const str = typeof d === 'string' ? d.replace(' ', 'T') : d;
        const dt = new Date(str);
        if (isNaN(dt.getTime())) return '';
        const pad = (n) => n.toString().padStart(2, '0');
        const day = pad(dt.getDate());
        const month = pad(dt.getMonth() + 1);
        const year = dt.getFullYear();
        let hours = dt.getHours();
        const minutes = pad(dt.getMinutes());
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        return `${day}-${month}-${year} ${pad(hours)}:${minutes} ${ampm}`;
    };

    async function loadChallans() {
        try {
            const response = await fetch('/api/challans');
            if (!response.ok) throw new Error('HTTP ' + response.status);
            const challans = await response.json();
            const tbody = document.querySelector("#challanTable tbody");
            tbody.innerHTML = "";
            challans.forEach(challan => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${escapeHtml(challan.challanNo)}</td>
                    <td>${escapeHtml(challan.customerName)}</td>
                    <td>${escapeHtml(fmtDate(challan.date))}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewChallan(${challan.id})">üëÅ View</button>
                        <a class="btn btn-sm btn-primary" href="/api/challan/download/${challan.id}">üñ®Ô∏è PDF</a>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (err) {
            console.error("Failed to fetch challans", err);
        }
    }

    async function viewChallan(id) {
        try {
            const response = await fetch(`/api/challan/${id}`);
            if (!response.ok) throw new Error("Challan not found");
            const challan = await response.json();
            const items = Array.isArray(challan.items) ? challan.items : [];
            let itemsRows = '', totalWeight = 0, totalAmount = 0, totalPieces = 0;

            items.forEach((item, idx) => {
                const weight = Number(item.weight) || 0;
                const pcsPerKg = Number(item.piecesPerKg) || 0;
                const rate = Number(item.ratePerPiece) || 0;
                const pcs = item.totalPieces || (weight * pcsPerKg);
                const amount = item.totalAmount || (pcs * rate);

                totalWeight += weight;
                totalPieces += pcs;
                totalAmount += amount;

                itemsRows += `<tr>
                    <td>${idx + 1}</td>
                    <td>${escapeHtml(item.description || "-")}</td>
                    <td>${escapeHtml(item.refChNo || "-")}</td>
                    <td>${escapeHtml(item.process || "-")}</td>
                    <td>${escapeHtml(item.hsnCode || "-")}</td>
                    <td>${escapeHtml(item.unit || "-")}</td>
                    <td class="text-right">${weight.toFixed(2)}</td>
                    <td class="text-right">${pcsPerKg.toFixed(2)}</td>
                    <td class="text-right">${rate.toFixed(2)}</td>
                    <td class="text-right">${pcs}</td>
                    <td class="text-right">${amount.toFixed(2)}</td>
                </tr>`;
            });

            if (!itemsRows) {
                itemsRows = `<tr><td colspan="11" class="text-center text-muted">No items found</td></tr>`;
            } else {
                itemsRows += `<tr class="fw-bold">
                    <td colspan="6" class="text-end">Total</td>
                    <td class="text-right">${totalWeight.toFixed(2)}</td>
                    <td></td><td></td>
                    <td class="text-right">${totalPieces}</td>
                    <td class="text-right">${totalAmount.toFixed(2)}</td>
                </tr>`;
            }

            document.getElementById("challanDetails").innerHTML = `
                <p><strong>Challan No :</strong> ${challan.challanNo}</p>
                <p><strong>OEM Supplier :</strong> ${challan.customerName}</p>
                <p><strong>Date :</strong> ${fmtDate(challan.date)}</p>
                <hr>
                <h6>Items:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>S.No</th>
                                <th>Item Name</th>
                                <th>Ref. Ch. No.</th>
                                <th>Process</th>
                                <th>HSN Code</th>
                                <th>Unit</th>
                                <th>Weight (Kg)</th>
                                <th>Pcs/Kg</th>
                                <th>Rate (‚Çπ/pc)</th>
                                <th>Total Pcs</th>
                                <th>Amount (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody>${itemsRows}</tbody>
                    </table>
                </div>
                <div class="text-end mt-3">
                    <h5><strong>Total Amount : ‚Çπ ${totalAmount.toFixed(2)}</strong></h5>
                </div>
            `;
            new bootstrap.Modal(document.getElementById("challanModal")).show();
        } catch (err) {
            console.error("Failed to fetch challan details", err);
        }
    }

    window.onload = loadChallans;
</script>
</body>
</html>