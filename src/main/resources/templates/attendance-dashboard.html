<!--===========================================================================================-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .card-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .card-summary .card {
            flex: 1;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .status-present { color: #28a745; font-weight: bold; }
        .status-absent { color: #dc3545; font-weight: bold; }
        table {
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin-top: 30px;
        }
        .chart-box {
            flex: 1 1 400px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Attendance Dashboard -
            <span th:text="${#temporals.format(today, 'dd-MM-yyyy')}"></span>
        </h3>
        <div>
            <a href="/employees" class="btn btn-primary">â¬… Back to Employees</a>
            <a href="/attendance" class="btn btn-info">ðŸ“… Mark Attendance</a>
            <a href="/challans" class="btn btn-primary btn-new">â¬… Back to Challans</a>
        </div>
    </div>

    <div class="card-summary">
        <div class="card p-3">
            <div>Total Employees</div>
            <div th:text="${totalEmployees}"></div>
        </div>
        <div class="card p-3 text-success">
            <div>Present</div>
            <div th:text="${presentCount}"></div>
        </div>
        <div class="card p-3 text-danger">
            <div>Absent</div>
            <div th:text="${absentCount}"></div>
        </div>
    </div>
    <!-- Charts Section -->
    <div class="chart-container">
        <!-- Pie Chart -->
        <div class="chart-box">
            <h5 class="text-center">Attendance Summary</h5>
            <canvas id="attendancePie"></canvas>
        </div>

        <!-- Bar Chart -->
        <div class="chart-box">
            <h5 class="text-center">Employee Attendance Status</h5>
            <canvas id="employeeBar"></canvas>
        </div>
    </div>

    <div th:if="${#lists.isEmpty(allAttendance)}" class="alert alert-warning mt-3">
        No attendance records found for today.
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    const presentCount = [[${presentCount}]];
    const absentCount = [[${absentCount}]];
    const allAttendance = /*[[${allAttendance}]]*/ [];

    // ðŸ¥§ Pie Chart - Overall Attendance Summary
    const ctx1 = document.getElementById('attendancePie').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: ['Present', 'Absent'],
            datasets: [{
                data: [presentCount, absentCount],
                backgroundColor: ['#28a745', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                title: { display: true, text: 'Attendance Summary' }
            }
        }
    });

    // ðŸ“Š Bar Chart - Check-In / Check-Out for All Employees
    const labels = allAttendance.map(a => a.employee ? a.employee.name : a.name);

    // Convert DateTime to decimal hours
    function timeToHours(dateTime) {
        if (!dateTime) return null;
        const d = new Date(dateTime);
        return d.getHours() + d.getMinutes() / 60;
    }

    // Prepare dataset values
    const checkInTimes = allAttendance.map(a => timeToHours(a.checkInDateTime));
    const checkOutTimes = allAttendance.map(a => timeToHours(a.checkOutDateTime));

    const ctx2 = document.getElementById('employeeBar').getContext('2d');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Check-In',
                    data: checkInTimes,
                    backgroundColor: '#007bff'
                },
                {
                    label: 'Check-Out',
                    data: checkOutTimes,
                    backgroundColor: '#ffc107'
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        generateLabels: (chart) => {
                            return [
                                { text: 'Check-In', fillStyle: '#007bff' },
                                { text: 'Check-Out', fillStyle: '#ffc107' },
                                { text: 'Present', fillStyle: '#28a745' },
                                { text: 'Absent', fillStyle: '#dc3545' }
                            ];
                        }
                    }
                },
                tooltip: {
                    usePointStyle: true,
                    callbacks: {
                        label: function () { return ''; }, // Remove default labels
                        title: (context) => `Employee: ${labels[context[0].dataIndex]}`,
                        afterBody: (context) => {
                            const idx = context[0].dataIndex;
                            const att = allAttendance[idx];
                            const status = att.status;
                            const checkIn = att.checkInDateTime
                                ? new Date(att.checkInDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                                : 'â€”';
                            const checkOut = att.checkOutDateTime
                                ? new Date(att.checkOutDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                                : 'â€”';

                            // ðŸŸ¦ Blue and ðŸŸ¨ Yellow boxes inside tooltip
                            return [
                                `Status: ${status}`,
                                `ðŸŸ¦ Check-In: ${checkIn}`,
                                `ðŸŸ¨ Check-Out: ${checkOut}`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Hour of Day' },
                    ticks: {
                        stepSize: 1,
                        callback: value => `${value}:00`
                    }
                },
                x: {
                    ticks: { autoSkip: false, maxRotation: 60, minRotation: 45 }
                }
            }
        }
    });
    /*]]>*/
</script>
</body>
</html>